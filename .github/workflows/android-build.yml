name: Build and Deploy Android App

on:
  push:
    tags:
      - 'v*'  # Deploy on version tags (e.g., v1.0.0)
  workflow_dispatch:  # Allow manual trigger
    inputs:
      deploy_to_play_store:
        description: 'Deploy to Google Play Store'
        required: true
        default: false
        type: boolean
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build React app
      run: npm run build
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install Android SDK components
      run: |
        sdkmanager "platforms;android-34" "platforms;android-35" "build-tools;34.0.0" "build-tools;35.0.0"
      
    - name: Make gradlew executable
      run: chmod +x android/gradlew
      
    - name: Set version code from tag
      if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION_CODE=$((10000 + GITHUB_RUN_NUMBER))
        echo "Setting version code to: $VERSION_CODE"
        sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
        sed -i "s/versionName \"[^\"]*\"/versionName \"$TAG_NAME\"/" android/app/build.gradle
        
    - name: Sync Capacitor
      run: npx cap sync android
      
    - name: Check Android setup
      run: |
        echo "Android project structure:"
        ls -la android/
        echo "Gradle wrapper:"
        ls -la android/gradlew || echo "gradlew not found"
        echo "Build gradle:"
        ls -la android/app/build.gradle || echo "build.gradle not found"
      
    - name: Validate required secrets
      if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_play_store == 'true') }}
      run: |
        if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "❌ ERROR: KEYSTORE_BASE64 secret is missing"
          exit 1
        fi
        if [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
          echo "❌ ERROR: KEYSTORE_PASSWORD secret is missing" 
          exit 1
        fi
        if [ -z "${{ secrets.KEY_ALIAS }}" ]; then
          echo "❌ ERROR: KEY_ALIAS secret is missing"
          exit 1
        fi
        if [ -z "${{ secrets.KEY_PASSWORD }}" ]; then
          echo "❌ ERROR: KEY_PASSWORD secret is missing"
          exit 1
        fi
        echo "✅ All required secrets are present"
        
    - name: Decode and setup upload keystore
      if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_play_store == 'true') }}
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
        echo "KEYSTORE_FILE=true" >> $GITHUB_ENV
        echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
        echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
        echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
        
    - name: Build and Sign Android APK
      run: |
        cd android
        ./gradlew clean
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: Build and Sign Android App Bundle (AAB)
      run: |
        cd android
        ./gradlew bundleRelease --no-daemon --stacktrace
        
    - name: Verify signing
      run: |
        if [ -f android/app/build/outputs/apk/release/app-release.apk ]; then
          echo "✅ APK built successfully"
          if apksigner verify android/app/build/outputs/apk/release/app-release.apk; then
            echo "✅ APK is properly signed"
          else
            echo "❌ APK signing verification failed"
            exit 1
          fi
        fi
        if [ -f android/app/build/outputs/bundle/release/app-release.aab ]; then
          echo "✅ AAB built successfully"
          if jarsigner -verify android/app/build/outputs/bundle/release/app-release.aab; then
            echo "✅ AAB is properly signed"
          else
            echo "❌ AAB signing verification failed"
            exit 1
          fi
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: chord-riff-generator-apk
        path: android/app/build/outputs/apk/release/app-release.apk
        
    - name: Upload AAB
      uses: actions/upload-artifact@v4
      with:
        name: chord-riff-generator-aab
        path: android/app/build/outputs/bundle/release/app-release.aab
        
    - name: Validate Play Store secrets
      if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_play_store == 'true') }}
      run: |
        if [ -z "${{ secrets.SERVICE_ACCOUNT_JSON }}" ]; then
          echo "❌ ERROR: SERVICE_ACCOUNT_JSON secret is missing for Play Store upload"
          exit 1
        fi
        echo "✅ Play Store secrets validated"
        
    - name: Upload to Google Play Store (Internal Testing)
      if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_play_store == 'true') }}
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
        packageName: com.chordriff.generator
        releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
        track: internal
        status: completed
        inAppUpdatePriority: 2
        releaseName: "${{ github.ref_name }} - Chord Riff Generator"
        
    - name: Create Release Info
      run: |
        echo "## 📱 Chord Riff Generator - Android Release" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ✅ Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **APK**: Ready for sideloading or testing" >> $GITHUB_STEP_SUMMARY
        echo "- **AAB**: Ready for Google Play Store upload" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.deploy_to_play_store }}" == "true" ]]; then
          echo "### 🚀 Auto-Deploy Status:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Uploaded to Google Play Internal Testing track" >> $GITHUB_STEP_SUMMARY
          echo "- 🔗 Check [Google Play Console](https://play.google.com/console/) for deployment status" >> $GITHUB_STEP_SUMMARY
          echo "- 📈 Promote through tracks: Internal → Alpha → Beta → Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Version Information:" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "### 📋 To Deploy to Google Play Store:" >> $GITHUB_STEP_SUMMARY
          echo "1. Create a version tag (e.g., \`git tag v1.0.0 && git push origin v1.0.0\`)" >> $GITHUB_STEP_SUMMARY
          echo "2. Or use the 'Actions' tab → 'Build and Deploy Android App' → 'Run workflow' with deployment enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Manual Upload Alternative:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the AAB file from the artifacts above" >> $GITHUB_STEP_SUMMARY
          echo "2. Go to [Google Play Console](https://play.google.com/console/)" >> $GITHUB_STEP_SUMMARY
          echo "3. Navigate to your app → Testing → Internal testing" >> $GITHUB_STEP_SUMMARY
          echo "4. Create new release and upload the AAB file" >> $GITHUB_STEP_SUMMARY
        fi